
@page
@model UserMatch
@{
    ViewData["Title"] = "User Matching";
}
<h1>@ViewData["Title"]</h1>

<p>Use this page to detail user matching.</p>



<label for="ddGames">Preferred Games:</label>
<select id="ddGames">
</select>

<br />
<h1>Matched Users</h1>
<button class="userListButton">Get Matched Users</button>
<div id="matchedUserListContainer"></div>

 



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        var hostName = "https://localhost:44380/";

        $.ajax({
            type: "GET",
            contentType: "application/json",

            // not sure what the endpoint is below

            url: hostName+"api/GamePreferences/"+getCookie("userId")+"/GamePreferences",
            success: function (data) {
                //console.log(JSON.stringify(data));
                $.each(data, function (i, gameName) {
                var gameId = data[i]["gameId"];

                $.ajax({
                    type: "GET",
                    contentType: "application/json",

                    // not sure what the endpoint is below

                    url: hostName+"api/Games/" + gameId,
                    success: function (data) {
                        console.log(JSON.stringify(data));
                        console.log(data["name"]);

                        var gameName = data["name"];



                        //Not sure if gameName exists - where the name of the game is stored? assuming in the preferredGames tabl

                        var div_data = "<option value="+data["id"]+">"+gameName+"</option>"
                        //ddGames.append($("option").val(gameName).text(gameName));
                        $(div_data).appendTo('#ddGames');
                    

                    },
                    error: function () {
                        console.log("Error retrieving game names");
                    }
                });

                //Not sure if gameName exists - where the name of the game is stored? assuming in the preferredGames tabl                

                
           
                })

            },
            error: function () {
                console.log("Error retrieving game names");
            }
        });



        $(".userListButton").on('click', function () {
            $.ajax({
                type: "GET",
                contentType: "application/json",

                //FOR THE URL: We need to replace 101 with the logged in User ID. We need to replace 2 with the selected Game ID from the dropdown.

                url: hostName+"api/Matches/"+getCookie("userId")+"/2", // Change this to the appropriate server endpoint and  or ELO value ( im not sure if we are even matching by ELO?)
                success: function (res) {
                    //console.log(res);
                    //alert("Check console log for user list.");
                    var pref = res;

                    // Process the list of users as needed (table)
                    $.ajax({
                        type: "GET",
                        contentType: "application/json",
                        url: hostName+"api/Users/" + pref.userId,
                        success: function (data) {
                            console.log(data)
                            console.log(pref)

                            var tableHtml = "<table><thead><tr><th>Name</th><th>ELO</th></tr></thead><tbody>";
                            //for (var i = 0; i < res.length; i++) {
                            //    var user = res[i];
                            tableHtml += "<tr><td>" + data.username + "</td><td>" + pref.gamePreferences[0]["elo"] + "</td></tr>";
                            //}
                            tableHtml += "</tbody></table>";
                            $("#matchedUserListContainer").html(tableHtml);
                        }
                        
                    })

                    
                },

                error: function (msg) {
                    alert("Error: " + msg);
                }
            });
        });


        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            let name = cname + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }



    });

           

</script>